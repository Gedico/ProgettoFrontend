<!DOCTYPE html>
@if (caricamento) {
<div class="loading">Caricamento inserzione...</div>
}

@if (!caricamento && inserzione) {
<div class="container-inserzione">

<!-- HEADER -->
@if (inserzione.dati) {
<div class="header">
  <h1>{{ inserzione.dati.titolo }}</h1>
  <div class="prezzo-dettaglio">
    {{ inserzione.dati.prezzo | currency:'EUR':'symbol':'1.0-0' }}
  </div>
</div>
}

<!-- BOTTONI -->
@if (isUtente()) {
<button
  class="proposta-btn"
  [disabled]="haTrattativaInCorso"
  (click)="toggleFormOfferta()">
  üí∂ Fai un'offerta
</button>
}

@if (isAgente()) {
<button
  class="proposta-btn manuale"
  (click)="vaiAPropostaManuale()">
  üìù Inserisci offerta manuale
</button>
}

@if (haTrattativaInCorso) {
<p class="hint-trattativa">
  Hai gi√† una trattativa in corso per questa inserzione.
</p>
}

<!-- CONTROPROPOSTA -->
@if (contropropostaAgente && contropropostaAgente.stato === 'CONTROPROPOSTA') {
<div class="alert-controproposta">

  <div class="alert-header">
    <span class="icon">üì©</span>
    <h3>Controproposta dell‚Äôagente</h3>
  </div>

  <p class="alert-text">
    Importo:
    <b>{{ contropropostaAgente.importo | currency:'EUR':'symbol':'1.0-0' }}</b>
  </p>

  @if (contropropostaAgente.messaggio) {
  <p class="alert-note">
    <strong>Nota:</strong><br />
  {{ contropropostaAgente.messaggio }}
  </p>
  }

  <div class="alert-actions">
    <button class="btn-accetta" (click)="accettaControproposta()">‚úî Accetta</button>
    <button class="btn-rifiuta" (click)="rifiutaControproposta()">‚úñ Rifiuta</button>
  </div>

  <p class="alert-reminder">
    Rispondi alla controproposta per proseguire la trattativa.
  </p>

</div>
}

<!-- MODAL OFFERTA -->
@if (mostraFormOfferta && !haTrattativaInCorso) {
<div class="overlay" (click)="toggleFormOfferta()"></div>

<div class="modal-card">
  <h2>Invia una proposta</h2>

  <p class="hint">
    Prezzo minimo accettato:
    <b>{{ prezzoMinimo | currency:'EUR':'symbol':'1.0-0' }}</b>
  </p>

  <form [formGroup]="offertaForm" (ngSubmit)="inviaProposta()">

    <label>Importo offerta (‚Ç¨)</label>
    <input
      type="text"
      class="input-field"
      formControlName="prezzoProposta"
      appCurrencyInput />

    @if (prezzoProposta?.touched && prezzoProposta?.invalid) {
    <div class="validation">
      @if (prezzoProposta?.errors?.['required']) {
    L'importo √® obbligatorio.
    }
    @if (prezzoProposta?.errors?.['min']) {
    L'importo deve essere almeno
    {{ prezzoMinimo | currency:'EUR':'symbol':'1.0-0' }}.
    }
    </div>
    }

    <label>Note (opzionale)</label>
    <textarea
      class="textarea-field"
      formControlName="note">
          </textarea>

    <button
      type="submit"
      class="submit-btn"
      [disabled]="offertaForm.invalid">
      Invia proposta
    </button>

    <button
      type="button"
      class="close-btn"
      (click)="toggleFormOfferta()">
      Chiudi
    </button>
  </form>
</div>
}

<!-- FOTO -->
@if (inserzione.foto.length) {
<div class="galleria">
  <img
    class="foto-principale"
    [src]="inserzione.foto[0].url"
    alt="Foto principale" />
</div>
}

<!-- DETTAGLI -->
@if (inserzione.dati) {
<div class="dettagli">
  <h3>Dettagli</h3>
  <p><strong>Superficie:</strong> {{ inserzione.dati.dimensioni }} m¬≤</p>
  <p><strong>Stanze:</strong> {{ inserzione.dati.numeroStanze }}</p>
  <p><strong>Piano:</strong> {{ inserzione.dati.piano }}</p>
  <p><strong>Ascensore:</strong> {{ inserzione.dati.ascensore ? 'S√¨' : 'No' }}</p>
  <p><strong>Classe energetica:</strong> {{ inserzione.dati.classeEnergetica }}</p>
</div>
}

<!-- DESCRIZIONE -->
@if (inserzione.dati) {
<div class="descrizione">
  <h3>Descrizione</h3>
  <p>{{ inserzione.dati.descrizione }}</p>
</div>
}

<!-- INDICATORI -->
@if (inserzione.indicatore) {
<div class="indicatori">
  <h3>Servizi nelle vicinanze</h3>

  <p>
    üè´ Scuole:
    <strong>{{ inserzione.indicatore.scuoleVicine ? 'S√¨' : 'No' }}</strong>
  </p>

  <p>
    üå≥ Parchi:
    <strong>{{ inserzione.indicatore.parchiVicini ? 'S√¨' : 'No' }}</strong>
  </p>

  <p>
    üöâ Mezzi pubblici:
    <strong>{{ inserzione.indicatore.mezziPubbliciVicini ? 'S√¨' : 'No' }}</strong>
  </p>
</div>
}


<!-- POSIZIONE -->
@if (inserzione.posizione) {
<div class="posizione">
  <h3>Posizione</h3>
  <p>{{ inserzione.posizione.indirizzo }}</p>
  <iframe [src]="mappaUrl"></iframe>
</div>
}

</div>
}

