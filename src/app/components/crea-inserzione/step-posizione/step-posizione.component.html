<div [formGroup]="posizioneForm" class="step-posizione-container">

  <!-- Introduzione Step -->
  <div class="step-intro">
  <h2 class="step-main-title">
    <span class="accent">Dove</span> si trova l'immobile?
  </h2>
  <p class="step-description">
    Inserisci la posizione esatta per aiutare i potenziali acquirenti a trovare la propriet√†
  </p>
</div>


  <!-- Form Content -->
  <div class="form-content">

    <!-- COMUNE -->
    <div class="form-group">
      <label for="comune" class="form-label required">
        <span class="label-icon">üèòÔ∏è</span>
        Comune
      </label>

      <div class="autocomplete-container">
        <input
          id="comune"
          type="text"
          class="form-control"
          [class.has-value]="posizioneForm.get('comune')?.value"
          [class.ng-invalid]="posizioneForm.get('comune')?.touched && posizioneForm.get('comune')?.invalid"
          [class.ng-valid]="posizioneForm.get('comune')?.touched && posizioneForm.get('comune')?.valid"
          formControlName="comune"
          placeholder="Es. Napoli, Roma, Milano..."
          autocomplete="off"
        />

        <!-- Dropdown Suggerimenti -->
        @if (comuniFiltrati.length > 0) {
          <ul class="autocomplete-dropdown">
            @for (comune of comuniFiltrati; track comune) {
              <li
                class="autocomplete-item"
                (click)="selezionaComune.emit(comune)">
                <span class="item-icon">üìå</span>
                <span class="item-text">{{ comune }}</span>
              </li>
            }
          </ul>
        }
      </div>

      <!-- Messaggi di Validazione -->
      @if (posizioneForm.get('comune')?.touched && posizioneForm.get('comune')?.errors?.['required']) {
        <small class="error-message">
          ‚ö†Ô∏è Il comune √® obbligatorio
        </small>
      }

      @if (posizioneForm.get('comune')?.valid && posizioneForm.get('comune')?.value) {
        <small class="success-message">
          ‚úì Comune valido
        </small>
      }
    </div>

    <!-- INDIRIZZO -->
    <div class="form-group">
      <label for="indirizzo" class="form-label required">
        <span class="label-icon">üè†</span>
        Indirizzo completo
      </label>

      <input
        #indirizzoInput
        id="indirizzo"
        type="text"
        class="form-control"
        [class.has-value]="posizioneForm.get('indirizzo')?.value"
        [class.ng-invalid]="posizioneForm.get('indirizzo')?.touched && posizioneForm.get('indirizzo')?.invalid"
        [class.ng-valid]="posizioneForm.get('indirizzo')?.touched && posizioneForm.get('indirizzo')?.valid"
        formControlName="indirizzo"
        placeholder="Es. Via Roma 123"
        autocomplete="off"
      />

      <small class="form-text">
        üí° Inizia a digitare per vedere i suggerimenti automatici
      </small>

      <!-- Messaggi di Validazione -->
      @if (posizioneForm.get('indirizzo')?.touched && posizioneForm.get('indirizzo')?.invalid) {
        <small class="error-message">
          ‚ö†Ô∏è L'indirizzo √® obbligatorio
        </small>
      }

      @if (posizioneForm.get('indirizzo')?.valid && posizioneForm.get('indirizzo')?.value) {
        <small class="success-message">
          ‚úì Indirizzo completo
        </small>
      }
    </div>

    <!-- Info Box -->
    @if (!posizioneForm.get('comune')?.value) {
      <div class="info-box">
        <div class="info-icon">‚ÑπÔ∏è</div>
        <div class="info-content">
          <strong>Suggerimento:</strong> Seleziona prima il comune, poi inserisci l'indirizzo specifico.
          Questo ci aiuta a posizionare correttamente l'immobile sulla mappa.
        </div>
      </div>
    }

    <!-- Progress Indicator -->
    <div class="field-progress">
      <div class="progress-bar">
        <div
          class="progress-fill"
          [style.width]="getProgressPercentage() + '%'">
        </div>
      </div>
      <small class="progress-text">
        {{ getFilledFieldsCount() }} di 2 campi compilati
      </small>
    </div>

  </div>

  <!-- Navigazione -->
  <div class="button-group">
    <button
      type="button"
      class="btn btn-primary"
      (click)="nextStep.emit()"
      [disabled]="!posizioneForm.valid">
      @if (posizioneForm.valid) {
        Continua ‚Üí
      } @else {
        Compila tutti i campi
      }
    </button>
  </div>

</div>
