<div class="cp-card">
  <div class="cp-head">
    <div class="cp-title">
      <h3>Sicurezza account</h3>
      <p>Aggiorna la password per mantenere il tuo account protetto.</p>
    </div>
  </div>

  <form class="cp-form" [formGroup]="form" (ngSubmit)="submit()">
    <!-- Password attuale -->
    <div class="field">
      <label for="oldPassword">Password attuale</label>

      <div class="input-wrap">
        <input
          id="oldPassword"
          [type]="showOld ? 'text' : 'password'"
          formControlName="oldPassword"
          [class.invalid]="oldPassword?.touched && oldPassword?.invalid"
          autocomplete="current-password"
          placeholder="Inserisci la password attuale"
        />

        <button type="button" class="toggle" (click)="toggle('old')" [attr.aria-label]="showOld ? 'Nascondi password' : 'Mostra password'">
          {{ showOld ? 'Nascondi' : 'Mostra' }}
        </button>
      </div>

      @if (oldPassword?.touched && oldPassword?.hasError('required')) {
        <small class="error">Campo obbligatorio</small>
      }
    </div>

    <!-- Nuova password -->
    <div class="field">
      <label for="newPassword">Nuova password</label>

      <div class="input-wrap">
        <input
          id="newPassword"
          [type]="showNew ? 'text' : 'password'"
          formControlName="newPassword"
          [class.invalid]="newPassword?.touched && newPassword?.invalid"
          autocomplete="new-password"
          placeholder="Minimo 8 caratteri"
        />

        <button type="button" class="toggle" (click)="toggle('new')" [attr.aria-label]="showNew ? 'Nascondi password' : 'Mostra password'">
          {{ showNew ? 'Nascondi' : 'Mostra' }}
        </button>
      </div>

      @if (newPassword?.touched && newPassword?.hasError('required')) {
        <small class="error">Campo obbligatorio</small>
      }
      @if (newPassword?.touched && newPassword?.hasError('minlength')) {
        <small class="error">Minimo 8 caratteri</small>
      }
    </div>

    <!-- Conferma -->
    <div class="field">
      <label for="confirmPassword">Conferma nuova password</label>

      <div class="input-wrap">
        <input
          id="confirmPassword"
          [type]="showConfirm ? 'text' : 'password'"
          formControlName="confirmPassword"
          autocomplete="new-password"
          placeholder="Ripeti la nuova password"
        />

        <button type="button" class="toggle" (click)="toggle('confirm')" [attr.aria-label]="showConfirm ? 'Nascondi password' : 'Mostra password'">
          {{ showConfirm ? 'Nascondi' : 'Mostra' }}
        </button>
      </div>

      @if (confirmPassword?.touched && confirmPassword?.hasError('required')) {
        <small class="error">Campo obbligatorio</small>
      }
      @if (form.hasError('passwordMismatch') && form["touched"]) {
        <small class="error">Le password non coincidono</small>
      }
    </div>

    <button class="cp-btn" type="submit" [disabled]="loading || form.invalid">
      @if (loading) {
        <span class="btn-spinner"></span>
        Salvataggio...
      } @else {
        Aggiorna password
      }
    </button>

    <p class="cp-hint">
      Consiglio: usa una password lunga e unica (lettere, numeri e simboli).
    </p>
  </form>
</div>
